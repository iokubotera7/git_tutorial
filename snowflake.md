# データロード
Snowflakeでは、以下からのデータをSnowflakeにアップロードすることができる。
* ローカルデータ
* Amazon S3
* Google Cloud Storage
* Microsoft Azure

## データロードの手順
1. PUTコマンドを使用して、データファイルをデータロードの中間領域にアップロード（ステージング）する。
2. COPY INTO <テーブル>コマンドを使用して、ステージングされたファイルの内容をSnowflakeデータベーステーブルにアップロードする。

すなわち、S3⇒ステージング⇒テーブルの順番になる、  
このとき、ステージングからテーブルまでのデータのアップロードにCOPY INTO <テーブル>が用いられる。

まずは、PUTコマンドでファイルをステージングへ、ステージングにあるデータをCOPY INTO <テーブル>でテーブルへ。

1. createコマンドで内部ステージを作成
2. putコマンドでステージへファイルをアップロード
3. copy into コマンドでステージからsnowflakeのテーブルへアップロード


データをロードするには、ウェアハウスが必要。  

どのサブネットがどのインタネーットゲートウェイとつながっているのを記載。

EgressインターネットGW：IPv6専用のインターネットGW  


キャリアゲートウェイ：5G専用のゲートウェイ

Elastic IPアドレス：固定IPアドレス

マネージドプレフィックスリスト：IPアドレス範囲をリストとして設定する
エンドポイントはVPCの外のAWSのサービスとやり取りする。
エンドポイントサービスの作成：VPCのサービスを他のAWSアカウントを利用させるための設定

NATゲートウェイ：プライベートサブネットからのインターネット外へのトラフィック転送の機能。

ピアリング接続：VPC同士の接続に用いる。

ネットワークACL：VPCへのトラフィックの許可・拒否の設定
セキュリティグループ：インスタンス用のセキュリティ設定
Route53 Resolver DNS Firewall： DNSクエリのセキュリティ
AWS Network Firewall：VPCのファイアウォール。Network Firewall用のサブネットを作成し、Firewallが許可したトラフィックのみサブネットに転送する。  
カスタマーゲートウェイ：VPNや専用線接続などを用いて、オンプレミス環境との接続に用いる。
仮想プライベートゲートウェイ：VPNで接続するのに用いる。
VPN接続：VPCとVPNで接続するのに用いる。
Transit Gateway：複数のVPC間の接続に用いる。
Network Manager：VPCへのアクセス状況の確認やネットワークの全体的な管理、セキュリティの確認等が可能。  


AZ：データセンタの場所。冗長化を考えると複数あった方がいい。ap-XXX、ap-XXXみたいなの

ルートテーブルはルータの中に配置される。
そのため、パブリックサブネットを作成するためには、サブネット内のルータとインターネットGW内のルータそれぞれのルートテーブに  
ルーティングする必要がある。  

すべてのIPアドレス（ループバックアドレスを除く）0.0.0.0はインターネットGWに転送する。

IPマスカレード：複数のプライベートIPアドレスをグローバルIPアドレスに変換する。  

プライベートサブネットへのダイレクトなインターネットからのインバウンド通信は不可。
そんため、インターネットからのインバウンド通信には、パブリックサブネットに踏み台サーバを設置し、  
台サーバを経由してプライベートサブネットへアクセスする。  
プライベートサブネットからインターネットへのアウトバウンド通信は、NATゲートウェイを介して通信する。  

AMIの選択
  OSイメージの選択(Amazon Linuxなど)
インスタンスタイプ
  CPUのクロック数とコア数
  メモリ容量
ストレージタイプ
  ネットワークディスク（EBS）
  
EC2は任意のAZにインスタンスを立ち上げる  

インスタンスタイプの種類
t2.nano
tというのはファミリー。汎用型、コンピューティング最適化、メモリ最適化、ストレージ最適化、高速コンピューティングなどがある。
2は世代、１とか３とかもある。
nanoはインスタンスの容量

インスタンスストア：EC2に内蔵されていて、EC2の一時的なデータが保持され、EC2の停止・終了されるとデータ削除される。無料  
Elastic Block Store(EBS)：EC2とは独立して管理されている。EC2とは別の料金が発生する。  

リザーブドインスタンス：１～３年など長期的にインスタンスを利用する場合に、契約すると最大で７０％ほど割引される。
スポットインスタンス：AWSが管理している

キャパシティの予約：特定のAZのEC2インスタンスに対して任意の期間キャパシティを予約することで、

ハードウェア専有インスタンス：専用のHWのVPCで実行されるEC2インスタンス
Dedicated Host：EC2インスタンス容量を完全にお客様専用として利用できる物理サーバ。  
Bare Metal：アプリが基盤となるサーバのプロセッサとメモリに直接アクセス可能なインスタンス。  

リザーブドインスタンスの特徴
利用期間を長期指定して利用する形式で、オンデマンドに比較して最大７５％割安になる。
リザーブドインスタンスの種類
スタンダード
コンパーティブル

スポットインスタンスの特徴
一時的にAWSが用意しているコンピューティング容量を用いてインスタンスを動作させるため、最大９０％割引される。  
ただし、予備用のコンピューティング容量のため途中で削除される可能性がある一時利用用のインスタンス  
事前に上限価格とインスタンスタイプを選択し、上限内まで利用可能。  
スポットフリートを利用することで、自動でスポットインスタンスのリクエストを最適化できる。  
EC2フリートの利用  
オンデマンド、リザーブド、スポットインスタンスで構成されるインスタンスセットを定義する仕組み。  

EC2のリカバリー  
定期的なAMI、データをスナップショットでバックアップを取る必要がある。  
CloudWatchによりインスタンスのステータスをモニタリングする。  
キャパシティの予約は、細かいスケジュールで、ホストを専有できる機能  

プレイスメントグループは、EC2インスタンスをグループ化する機能  
ロードバランサーは、複数のEC2インスタンス

EC2が高負荷になった際に、自動でインスタンスを起動する機能で、AutoScalingがある。

ユーザデータ
⇒インスタンス起動時に自動でソフトウェアのインストールなど実行する 

公開鍵で暗号化して、秘密鍵で復号化する  

データベースを設定する構成パターンは３つ
* 単一のインスタンスにWebサーバとDBをインストールする
* EC2インスタンスを複数用意し、一方にWebサーバ、一方にDBを配置する。DBはプライベートサブネットに、Webサーバはパブリックサブネットに配置する。  
* EC2を複数用意し、パブリックサブネットにEC2インスタンスを、プライベートサブネットにRDSのAWSサービスを利用する  

インスタンスを起動する際に、インスタンス内でインストールするパッケージや設定を自動化することをユーザデータという。  

起動テンプレートというインスタンスを生成する際に設定するインスタンスタイプやネットワーク設定などのテンプレートを作成することができる。このテンプレートを使うことで、インスタンス生成を自動でできる。 


外部ステージは、SnowflakeからAWSのS3バケット上の特定のフォルダを参照する。
外部ステージを使うことで、S3バケット上のファイルをCOPYコマンドでSnowflakeのテーブルにロードできる。  

ただし、COPYを実行するには、SnowflakeのAWSアカウントからS3バケットが存在するAWSアカウントへの読み込み権限が必要。 
ストレージ統合を使うことで、S3バケットに対する読み込みを許可するIAMロールの権限を取得できる。  

## RDS
Amazon Relational Database ServiceとはAWSで使用できるリレーショナルデータベース。  

## RDSの特徴
* 高速化
  * RDSでリードレプリカを使用してDBを高速化することができる。リードレプリカとは、読み取り専用のDB。これを複数設置することで  
  * 大量の読み込みリクエストが来てもパフォーマンスを落とさずに処理が可能。  
* 可用性と耐久性
  * マルチAZ配置することで可用性と耐久性が可能。
  * マルチAZ配置では、スタンバイレプリカ（バックアップ用DB）とプライマリDB(元のDB)とは別のAZに配置する。  
  * もし、プライマリDBに何等かの障害が発生した場合はスタンバイレプリカに自動的に切り替え、サービスへの影響を抑える  
* 高いスケーラビリティ
  * DBを停止することなくストレージを追加することが可能  
* 暗号化
  * KMSやAWS CloudHSMという暗号化サービスを使うことができる  
* 複数のDBエンジンを使用することが可能
  * Oracle
  * MySQL
  * MariaDB
  * SQL Server
  * PostgreSQL
  * Amazon Aurora


## ELB
Elastic Load Balancingとは、外部からのリクエストを複数のサーバに振り分け負荷分散するロードバランサーのサービス  
AWSのELBはアプリケーションへの負荷やCPUの稼働状況をリアルタイムにモニタリングできるロードバランサー。  
これにより、システムのボトルネックを見つけて、アクセスを自動的に分散する.  
ヘルスチェック機能もあり、ロードバランサーの内側にあるサービスの状態をモニタリングできる  

ELBのほかにも、Webサービスに発生する負荷を分散するALB(Application Load Balancing)なNLBなどがある。  
ELBは総称であり、４つの種類がある。  

* ALB：HTTP、HTTPSのレイヤー７に対応する単一ロードバランサー。Webアプリで用いられる  
* NLB：TCP、UDPのレイヤー４で動作し、リクエストの内容によってターゲットをに振り分ける。低遅延で大量のアクセスを分散することが可能。  
* CLB：複数のEC2に対して負荷分散を行う。


単一EC2インスタンス+複数のRDSの場合、RDSはマルチAZに配置していた場合、スタンバイレプリカにプライマリDBがダウンしても切り替える冗長化構成が取れているが、EC2は単一だと障害が発生した場合サービスにアクセスできなくなる  

別々のAZ・サブネットに複数のEC2を用意した場合でも、片方に障害が発生した場合、ユーザ側で接続先のEC2を指定しなければならない。  

要するに、ユーザが接続先のEC2を意識せずとも負荷分散・障害発生時に接続先を自動切換え可能な機能が必要  

そこで使うのがELB。  
ELBはユーザから見たアクセス先をDNS名を指定する。  
ユーザからはELBにアクセスし、ELBからEC2にリクエストを振り分ける  
また、ELBでは以下の機能がある  
・ヘルスチェック：異常なインスタンスを検知し、通信をストップしてくれる機能。ヘルスチェックの対象として登録されたEC2へ定期的にリクエストを送信し、正常なレスポンスが返ってくるかで確かめる

・

RDSは停止中もストレージ料金が発生する
停止したRDSインスタンスは１週間で自動起動される

フェイルオーバーとは、プライマリDBが壊れたときに、予備機（スタンバイレプリカ）に自動切換えすること

* 可用性と耐久性

## サーバレスの目的
開発者はユーザに価値を提供することが目的にもかかわらず、サーバなど考えることが多い  
そこで、開発に特化し、余計なインフラの管理を省いたのがサーバレス  

## APIとは
プログラムやソフトウェア同士がやり取りするための取り決め・仕様  

Web APIを開発するときに考えるべきこと
* API自体の開発
* 高可用性・スケーラビリティ設計
* インフラの管理
* APIキーの管理
* デプロイ管理

API Gatewayを用いれば、API自体の開発のみに注力することが可能  

API Gatewayの機能

* リソースとメソッドタイプの定義
  * どのリソース(指定したUser IDに対して)に、どんな操作(GET, POSTなど)をするのか指定する
* メソッドリクエスト設定
  * リクエストの受付に関する設定を行う。認証の設定、受け付けるクエリパラメータなど、
* 統合タイプ設定
  * 統合バックエンドの種別を選択する(Lambda、HTTP、Mock、AWSサービス、VPCなど)
* Req/Res変換定義
  * 統合バックエンドへの入力データ、バックエンドからの出力データを変換できる。
  * プロキシ統合は変換せずにパススルーすることができる機能
* デプロイ
  * API単位にデプロイする。デプロイする際はステージを作成する必要がある

APIキーを作成して、使用量プラン(10000リクエストでXX円)を作成することができる。


DynamoDBの特徴

* 3つのAZに作られるので、信頼性が高い  

テーブルを作成する際に、プライマリーキーを作成する必要がある。
プライマリーキーには、パーティションキーとソートキーを用いる。
いずれか片方でも問題ない。  

つまり、パーティションキーのみをプライマリーキーとした場合、パーティションキーが重複してテーブルに登録することはできない  

LSIはソートキー以外に絞り込み検索を行うキーをもつことができる
パーティションキーはベーステーブルと同じ

キャパシティユニット
Read、Writeそれぞれのデータの読み・書き込み容量。
Read：1ユニットにつき、最大４KBのデータを読み込み可能
Write：1ユニットにつき、最大１KBのデータの書き込みが可能  

Dynamo DBではHTTPベースのAPIで操作を行う

データ作成：PutItem
データ取得：GetItem
複数データ取得：Query(指定したキーのみ), Scan(テーブルまたはセカンダリインデクスすべてを取得する
データの更新：UpdateItem

## なぜ監視が必要なのか
リソース監視
  CPU使用率、ストレージ使用料
ログ監視
  AWSサービス、OS、アプリケーション、ミドルウェア等

## AWSの監視サービス
* CloudWatch
  * メトリクス：CPUやメモリ使用率など
  * Logs：アプリケーションのログなど
* X-Ray
  Traces：アプリケーションの実行状況など
  
  ## AWS CloudFormation
  テンプレートファイルを使用して、システムをまとめて環境構築ができるサービス
  
  CPU使用率・メモリ使用率の確認⇒CloudWatch Metrics
  アプリケーションのログを収集するのにCloudWatch Logsがある
  ログを可視化するのに、CloudWatch Logs Insightsがある  
  
  メトリクスに応じたアクション（アラームなど）を実行するCloudWatch Alarmがある  
  
  リソース監視
  アプリケーション性能監視
  
  ClodWatchに発行されたメトリクス(CPU使用率など)を収集し、統計を取得

データポイントはタイムスタンプと測定データを保持  
メトリクスは時系列のデータポイントのセット  

名前空間
ディメンション：メトリクスを一意に識別する名前/値のペア名  

標準メトリクス：CPU・メモリ使用量
カスタムメトリクス：標準メトリクスで対応していないメトリクス（メモリ使用率、ディスク使用率など）  

